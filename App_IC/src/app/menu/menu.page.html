<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title> Rutas y Servicios Accesibles</ion-title>
    
    <ion-buttons slot="end">
      <ion-button *ngIf="isUserLoggedIn" (click)="getCurrentPosition()">
        <ion-icon slot="icon-only" name="locate"></ion-icon>
      </ion-button>
      <ion-button *ngIf="isUserLoggedIn" (click)="verMisRutas()">
        <ion-icon slot="icon-only" name="map"></ion-icon>
      </ion-button>
      
    </ion-buttons>
  </ion-toolbar>

  <!-- Barra de navegaci√≥n activa -->
  <ion-toolbar *ngIf="navegacionActiva" color="primary">
    <ion-grid>
      <ion-row>
        <ion-col size="8">
          <div style="padding-left: 10px;">
            <ion-text>
              <h3 style="margin: 0; font-size: 16px;">
                <ion-icon name="navigate"></ion-icon>
                {{ rutaNavegacion.nombre }}
              </h3>
              <p style="margin: 0; font-size: 12px;">
                {{ proximoPunto === 0 ? 'Ac√©rcate al inicio' : 'Siguiendo ruta...' }}
              </p>
            </ion-text>
          </div>
        </ion-col>
        <ion-col size="4">
          <ion-button fill="clear" color="light" size="small" (click)="detenerNavegacion()">
            <ion-icon slot="icon-only" name="close-circle"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>

  <!-- Barra de grabaci√≥n en tiempo real -->
  <ion-toolbar *ngIf="isRecording" color="danger">
    <ion-grid>
      <ion-row>
        <ion-col size="4">
          <div style="text-align: center;">
            <ion-text>
              <h3 style="margin: 0;">{{ totalDistance.toFixed(2) }}</h3>
              <p style="margin: 0; font-size: 12px;">km</p>
            </ion-text>
          </div>
        </ion-col>
        <ion-col size="4">
          <div style="text-align: center;">
            <ion-text>
              <h3 style="margin: 0;">{{ elapsedTime }}</h3>
              <p style="margin: 0; font-size: 12px;">tiempo</p>
            </ion-text>
          </div>
        </ion-col>
        <ion-col size="4">
          <div style="text-align: center;">
            <ion-text>
              <h3 style="margin: 0;">{{ recordedPoints.length }}</h3>
              <p style="margin: 0; font-size: 12px;">puntos GPS</p>
            </ion-text>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  
  <!-- üåü Mensaje de bienvenida para usuarios no logueados -->
  <ion-card *ngIf="!isUserLoggedIn" color="light">
    <ion-card-content>
      <h2 style="margin: 0 0 10px 0; text-align: center;">¬°Bienvenido!</h2>
      <p style="margin: 0; text-align: center;">
        Explora rutas accesibles y servicios para personas con discapacidad.
        <br><b>Inicia sesi√≥n</b> para guardar tus propias rutas GPS.
      </p>
    </ion-card-content>
  </ion-card>

  <!-- ü¶Ø BOT√ìN ACCESO PARA PERSONAS CON DISCAPACIDAD VISUAL -->
  <ion-card *ngIf="tieneDiscapacidadVisual" class="menu-blind-card" color="dark">
    <ion-card-content>
      <div style="text-align: center; padding: 15px;">
        <ion-icon name="eye-off" style="font-size: 60px; color: #fff;"></ion-icon>
        <h2 style="margin: 15px 0; color: #fff; font-size: 26px; font-weight: bold;">
          Men√∫ para Discapacidad Visual
        </h2>
        <p style="margin: 0 0 20px 0; color: #ddd; font-size: 18px;">
          Accede al men√∫ accesible con lectura de voz para personas con discapacidad visual
        </p>
        <ion-button 
          expand="block" 
          color="light"
          size="large"
          (click)="irAMenuBlind()"
          style="height: 60px; font-size: 20px; font-weight: bold;">
          <ion-icon slot="start" name="volume-high"></ion-icon>
          ACCEDER CON VOZ
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- üÜï BOT√ìN PARA DESCUBRIR RUTAS RECOMENDADAS -->
  <ion-card class="rutas-recomendadas-card">
    <ion-card-content>
      <div style="text-align: center; padding: 10px;">
        <ion-icon name="map" style="font-size: 48px; color: #667eea;"></ion-icon>
        <h2 style="margin: 10px 0; color: #333;">Descubre Nuevas Rutas</h2>
        <p style="margin: 0 0 15px 0; color: #000; font-weight: 500;">
          Explora rutas creadas por la comunidad y encuentra nuevos caminos accesibles
        </p>
        <ion-button 
          expand="block" 
          color="secondary"
          (click)="irARutasRecomendadas()">
          <ion-icon slot="start" name="navigate-circle"></ion-icon>
          Ver Rutas Recomendadas
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- üîç FILTRO POR TIPO DE DISCAPACIDAD -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="filter" style="vertical-align: middle;"></ion-icon>
        Filtrar Servicios por Discapacidad
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label>Tipo de Discapacidad</ion-label>
        <ion-select 
          [(ngModel)]="discapacidadSeleccionada" 
          (ionChange)="filtrarPorDiscapacidad()"
          interface="action-sheet"
          placeholder="Todos los servicios">
          <ion-select-option [value]="null">Todos los servicios</ion-select-option>
          <ion-select-option 
            *ngFor="let tipo of tiposDiscapacidad" 
            [value]="tipo.id_discapacidad">
            {{ tipo.nombre_discapacidad }}
          </ion-select-option>
        </ion-select>
      </ion-item>
      
      <!-- Bot√≥n para limpiar filtro -->
      <ion-button 
        *ngIf="discapacidadSeleccionada !== null"
        expand="block" 
        fill="outline" 
        color="medium"
        (click)="limpiarFiltro()"
        style="margin-top: 10px;">
        <ion-icon slot="start" name="close-circle"></ion-icon>
        Limpiar Filtro
      </ion-button>

      <ion-note color="medium" style="display: block; margin-top: 10px; font-size: 12px;">
        <span *ngIf="discapacidadSeleccionada === null">
          ‚ÑπÔ∏è Selecciona un tipo de discapacidad para ver solo los servicios adaptados en el mapa
        </span>
        <span *ngIf="discapacidadSeleccionada !== null">
          ‚úÖ Mostrando {{ serviciosFiltrados.length }} servicio(s) filtrado(s)
        </span>
      </ion-note>
    </ion-card-content>
  </ion-card>

  <ion-card color="warning" *ngIf="!currentLocation">
    <ion-card-content>
      <p style="margin: 0; font-size: 12px; text-align: center;">
        ‚ö†Ô∏è <b>GPS no conectado</b><br>
        Presiona el √≠cono üìç arriba para obtener tu ubicaci√≥n
      </p>
    </ion-card-content>
  </ion-card>
  
  <!-- üó∫Ô∏è Mapa principal -->
  <div id="map" style="height: 500px; width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 10px;"></div>

  <!-- üé¨ Controles de grabaci√≥n GPS -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="navigate-circle" style="vertical-align: middle;"></ion-icon>
        Grabar Mi Ruta GPS
      </ion-card-title>
      <ion-card-subtitle>
        {{ isRecording ? 'üî¥ GRABANDO GPS... Camina y tu ruta se guardar√° autom√°ticamente' : 'Crea y comparte tus rutas accesibles usando GPS real' }}
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <!-- Mensaje si no est√° logueado -->
      <ion-note *ngIf="!isUserLoggedIn" color="warning" style="display: block; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px;">
        üîí <b>Inicia sesi√≥n para grabar rutas</b><br>
        Debes tener una cuenta para guardar y compartir tus rutas GPS.
      </ion-note>

      <ion-button 
        *ngIf="!isRecording"
        expand="block" 
        color="success" 
        (click)="startRecording()">
        <ion-icon slot="start" name="play-circle"></ion-icon>
        Iniciar Grabaci√≥n GPS
      </ion-button>

      <ion-button 
        *ngIf="isRecording"
        expand="block" 
        color="danger" 
        (click)="stopRecording()">
        <ion-icon slot="start" name="stop-circle"></ion-icon>
        Finalizar y Guardar Ruta
      </ion-button>

      <!-- Informaci√≥n durante la grabaci√≥n -->
      <div *ngIf="isRecording" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
        <p style="margin: 5px 0; font-size: 14px;">
          <ion-icon name="speedometer" style="vertical-align: middle;"></ion-icon>
          <strong>Velocidad actual:</strong> {{ currentSpeed.toFixed(1) }} km/h
        </p>
        <p style="margin: 5px 0; font-size: 14px;">
          <ion-icon name="location" style="vertical-align: middle;"></ion-icon>
          <strong>Precisi√≥n GPS:</strong> Alta (tracking activo)
        </p>
      </div>

      <!-- Instrucciones cuando no est√° grabando -->
      <ion-text *ngIf="!isRecording" color="medium">
        <p style="font-size: 12px; margin-top: 10px;">
          üí° <b>C√≥mo funciona:</b><br>
          1Ô∏è‚É£ Presiona "Iniciar Grabaci√≥n GPS"<br>
          2Ô∏è‚É£ Camina o despl√°zate por tu ruta<br>
          3Ô∏è‚É£ El GPS grabar√° autom√°ticamente cada punto de tu recorrido<br>
          4Ô∏è‚É£ Presiona "Finalizar" cuando llegues al destino<br>
          5Ô∏è‚É£ Dale un nombre descriptivo y guarda tu ruta<br><br>
          
          üì± <b>Requisitos:</b><br>
          ‚Ä¢ GPS activado en tu dispositivo<br>
          ‚Ä¢ Conexi√≥n estable para mejor precisi√≥n<br>
          ‚Ä¢ Caminar al menos 10 metros para registrar puntos
        </p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <!-- üß© SECCI√ìN DE SERVICIOS DISPONIBLES (MODIFICADA) -->
  <ion-card id="servicios-section">
    <ion-card-header>
      <ion-card-title>
        üß© Servicios Disponibles
      </ion-card-title>
      <ion-card-subtitle>
        {{ servicioSeleccionado ? 'Informaci√≥n del servicio seleccionado' : 'Haz clic en un marcador amarillo üü° en el mapa para ver detalles' }}
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <!-- ‚úÖ Si hay un servicio seleccionado, mostrar solo ese -->
      <div *ngIf="servicioSeleccionado; else noSeleccionado">
        <!-- Bot√≥n para limpiar selecci√≥n -->
        <ion-button 
          fill="outline" 
          size="small" 
          color="medium" 
          (click)="limpiarSeleccionServicio()"
          style="margin-bottom: 15px;">
          <ion-icon slot="start" name="close-circle"></ion-icon>
          Limpiar selecci√≥n
        </ion-button>

        <!-- Informaci√≥n detallada del servicio seleccionado -->
        <ion-card style="margin: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          <ion-card-header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <ion-card-title>{{ servicioSeleccionado.nombre_servicio }}</ion-card-title>
            <ion-card-subtitle style="color: rgba(255,255,255,0.9);">
              {{ servicioSeleccionado.nombre_empresa }}
            </ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <p style="margin: 10px 0;">
              <strong>üìù Descripci√≥n:</strong><br>
              {{ servicioSeleccionado.descripcion_servicio || 'Sin descripci√≥n disponible' }}
            </p>
            
            <div style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 8px;">
              <p style="margin: 5px 0; font-size: 14px;">
                <strong>üìç Lugar:</strong> {{ servicioSeleccionado.nombre_lugar || 'N/A' }}
              </p>
              <p style="margin: 5px 0; font-size: 14px;">
                <strong>üìå Direcci√≥n:</strong> {{ servicioSeleccionado.direccion_lugar || 'N/A' }}
              </p>
              <p *ngIf="servicioSeleccionado.horario_disponible" style="margin: 5px 0; font-size: 14px;">
                <strong>üïê Horario:</strong> {{ servicioSeleccionado.horario_disponible }}
              </p>
              <p style="margin: 5px 0; font-size: 14px;">
                <strong>üí∞ Costo:</strong> {{ servicioSeleccionado.costo_servicio ? (servicioSeleccionado.costo_servicio | currency:'CLP':'symbol-narrow':'1.0-0') : 'Consultar' }}
              </p>
              <p *ngIf="servicioSeleccionado.nombre_discapacidad" style="margin: 5px 0; font-size: 14px;">
                <strong>‚ôø Discapacidad:</strong> {{ servicioSeleccionado.nombre_discapacidad }}
              </p>
              <p *ngIf="servicioSeleccionado.empresa_telefono" style="margin: 5px 0; font-size: 14px;">
                <strong>üìû Contacto:</strong> {{ servicioSeleccionado.empresa_telefono }}
              </p>
            </div>

            <!-- üÜï Bot√≥n "M√°s informaci√≥n" -->
            <ion-button 
              expand="block" 
              color="primary" 
              (click)="verMasInformacion()"
              style="margin-top: 20px;">
              <ion-icon slot="start" name="information-circle"></ion-icon>
              Ver m√°s informaci√≥n
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- ‚úÖ Si no hay servicio seleccionado, mostrar mensaje -->
      <ng-template #noSeleccionado>
        <div style="text-align: center; padding: 40px 20px; background: #f9f9f9; border-radius: 12px; border: 2px dashed #ddd;">
          <ion-icon name="hand-right" size="large" color="medium" style="font-size: 64px; margin-bottom: 15px; opacity: 0.5;"></ion-icon>
          <h3 style="margin: 10px 0; color: #666;">Selecciona un punto en el mapa</h3>
          <p style="margin: 5px 0; color: #999; font-size: 14px;">
            Haz clic en cualquier marcador amarillo üü° en el mapa<br>
            para ver la informaci√≥n detallada del servicio
          </p>
          <p style="margin: 15px 0 5px 0; color: #999; font-size: 13px;">
            <strong>{{ serviciosDisponibles.length }}</strong> servicio{{ serviciosDisponibles.length !== 1 ? 's' : '' }} disponible{{ serviciosDisponibles.length !== 1 ? 's' : '' }} en el mapa
          </p>
        </div>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <!-- üåü Informaci√≥n de rutas guardadas (solo si est√° logueado) -->
  <ion-card *ngIf="isUserLoggedIn">
    <ion-card-header>
      <ion-card-title>üåü Tus Rutas Guardadas</ion-card-title>
      <ion-card-subtitle>
        {{ rutasGuardadas.length === 0 ? 'A√∫n no has creado rutas' : rutasGuardadas.length + ' ruta(s) disponible(s)' }}
      </ion-card-subtitle>
    </ion-card-header>
    
    <ion-card-content>
      <div *ngIf="rutasGuardadas.length === 0">
        <p style="text-align: center; color: #666;">
          üìç No tienes rutas GPS guardadas a√∫n.<br>
          ¬°Crea tu primera ruta para ayudar a otros usuarios!
        </p>
      </div>

      <div *ngIf="rutasGuardadas.length > 0">
        <p>
          Tus rutas est√°n disponibles para visualizar. Usa los √≠conos arriba:
          <br>üìç = Ver tu ubicaci√≥n
          <br>üó∫Ô∏è = Ver/gestionar tus rutas
          <br>üåç = Ver rutas de otros usuarios
        </p>
        
        <ion-list>
          <ion-item *ngFor="let ruta of rutasGuardadas.slice(0, 3)">
            <ion-label>
              <h3>{{ ruta.nombre_ruta }}</h3>
              <p>{{ ruta.descripcion_ruta || 'Sin descripci√≥n' }}</p>
              <p><small>üìè {{ ruta.longitud_ruta }} km | üìç {{ ruta.coordenadas?.length || 0 }} puntos GPS</small></p>
            </ion-label>
            <ion-button slot="end" fill="clear" (click)="cargarRutaEnMapa(ruta.id_ruta)">
              <ion-icon name="eye" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>

        <ion-button 
          *ngIf="rutasGuardadas.length > 3"
          expand="block" 
          fill="outline" 
          (click)="verMisRutas()">
          <ion-icon slot="start" name="list"></ion-icon>
          Ver todas ({{ rutasGuardadas.length }})
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>