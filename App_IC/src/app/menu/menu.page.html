<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <!-- âœ… MenÃº hamburguesa siempre visible -->
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>ğŸ“ Rutas y Servicios Accesibles</ion-title>
    
    <ion-buttons slot="end">
      <!-- âœ… Solo botones de funcionalidad, Login/Registro estÃ¡n en el menÃº -->
      <ion-button *ngIf="isUserLoggedIn" (click)="getCurrentPosition()">
        <ion-icon slot="icon-only" name="locate"></ion-icon>
      </ion-button>
      <ion-button *ngIf="isUserLoggedIn" (click)="verMisRutas()">
        <ion-icon slot="icon-only" name="map"></ion-icon>
      </ion-button>
      <ion-button (click)="verRutasPublicas()">
        <ion-icon slot="icon-only" name="globe"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Barra de grabaciÃ³n en tiempo real -->
  <ion-toolbar *ngIf="isRecording" color="danger">
    <ion-grid>
      <ion-row>
        <ion-col size="4">
          <div style="text-align: center;">
            <ion-text>
              <h3 style="margin: 0;">{{ totalDistance.toFixed(2) }}</h3>
              <p style="margin: 0; font-size: 12px;">km</p>
            </ion-text>
          </div>
        </ion-col>
        <ion-col size="4">
          <div style="text-align: center;">
            <ion-text>
              <h3 style="margin: 0;">{{ elapsedTime }}</h3>
              <p style="margin: 0; font-size: 12px;">tiempo</p>
            </ion-text>
          </div>
        </ion-col>
        <ion-col size="4">
          <div style="text-align: center;">
            <ion-text>
              <h3 style="margin: 0;">{{ recordedPoints.length }}</h3>
              <p style="margin: 0; font-size: 12px;">puntos GPS</p>
            </ion-text>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  
  <!-- ğŸŒŸ Mensaje de bienvenida para usuarios no logueados -->
  <ion-card *ngIf="!isUserLoggedIn" color="light">
    <ion-card-content>
      <h2 style="margin: 0 0 10px 0; text-align: center;">Â¡Bienvenido!</h2>
      <p style="margin: 0; text-align: center;">
        Explora rutas accesibles y servicios para personas con discapacidad.
        <br><b>Inicia sesiÃ³n</b> para guardar tus propias rutas GPS.
      </p>
    </ion-card-content>
  </ion-card>

  <!-- ğŸ“ Panel de Debug GPS (temporal) -->
  <ion-card color="light" *ngIf="currentLocation">
    <ion-card-content>
      <p style="margin: 0; font-size: 11px;">
        <b>ğŸ›°ï¸ GPS Activo:</b><br>
        ğŸ“ Lat: {{ currentLocation[0].toFixed(6) }}<br>
        ğŸ“ Lng: {{ currentLocation[1].toFixed(6) }}
      </p>
    </ion-card-content>
  </ion-card>

  <ion-card color="warning" *ngIf="!currentLocation">
    <ion-card-content>
      <p style="margin: 0; font-size: 12px; text-align: center;">
        âš ï¸ <b>GPS no conectado</b><br>
        Presiona el Ã­cono ğŸ“ arriba para obtener tu ubicaciÃ³n
      </p>
    </ion-card-content>
  </ion-card>
  
  <!-- ğŸ—ºï¸ Mapa principal -->
  <div id="map" style="height: 500px; width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 10px;"></div>

  <!-- ğŸ¬ Controles de grabaciÃ³n GPS -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="navigate-circle" style="vertical-align: middle;"></ion-icon>
        Grabar Mi Ruta GPS
      </ion-card-title>
      <ion-card-subtitle>
        {{ isRecording ? 'ğŸ”´ GRABANDO GPS... Camina y tu ruta se guardarÃ¡ automÃ¡ticamente' : 'Crea y comparte tus rutas accesibles usando GPS real' }}
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <!-- Mensaje si no estÃ¡ logueado -->
      <ion-note *ngIf="!isUserLoggedIn" color="warning" style="display: block; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px;">
        ğŸ”’ <b>Inicia sesiÃ³n para grabar rutas</b><br>
        Debes tener una cuenta para guardar y compartir tus rutas GPS.
      </ion-note>

      <ion-button 
        *ngIf="!isRecording"
        expand="block" 
        color="success" 
        (click)="startRecording()">
        <ion-icon slot="start" name="play-circle"></ion-icon>
        Iniciar GrabaciÃ³n GPS
      </ion-button>

      <ion-button 
        *ngIf="isRecording"
        expand="block" 
        color="danger" 
        (click)="stopRecording()">
        <ion-icon slot="start" name="stop-circle"></ion-icon>
        Finalizar y Guardar Ruta
      </ion-button>

      <!-- InformaciÃ³n durante la grabaciÃ³n -->
      <div *ngIf="isRecording" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
        <p style="margin: 5px 0; font-size: 14px;">
          <ion-icon name="speedometer" style="vertical-align: middle;"></ion-icon>
          <strong>Velocidad actual:</strong> {{ currentSpeed.toFixed(1) }} km/h
        </p>
        <p style="margin: 5px 0; font-size: 14px;">
          <ion-icon name="location" style="vertical-align: middle;"></ion-icon>
          <strong>PrecisiÃ³n GPS:</strong> Alta (tracking activo)
        </p>
      </div>

      <!-- Instrucciones cuando no estÃ¡ grabando -->
      <ion-text *ngIf="!isRecording" color="medium">
        <p style="font-size: 12px; margin-top: 10px;">
          ğŸ’¡ <b>CÃ³mo funciona:</b><br>
          1ï¸âƒ£ Presiona "Iniciar GrabaciÃ³n GPS"<br>
          2ï¸âƒ£ Camina o desplÃ¡zate por tu ruta<br>
          3ï¸âƒ£ El GPS grabarÃ¡ automÃ¡ticamente cada punto de tu recorrido<br>
          4ï¸âƒ£ Presiona "Finalizar" cuando llegues al destino<br>
          5ï¸âƒ£ Dale un nombre descriptivo y guarda tu ruta<br><br>
          
          ğŸ“± <b>Requisitos:</b><br>
          â€¢ GPS activado en tu dispositivo<br>
          â€¢ ConexiÃ³n estable para mejor precisiÃ³n<br>
          â€¢ Caminar al menos 10 metros para registrar puntos
        </p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <!-- ğŸ§© SECCIÃ“N DE SERVICIOS DISPONIBLES -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        ğŸ§© Servicios Disponibles
      </ion-card-title>
      <ion-card-subtitle>
        {{ serviciosDisponibles.length }} servicio(s) para personas con discapacidad
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <!-- Lista de servicios -->
      <div *ngIf="serviciosDisponibles.length > 0">
        <p style="margin-bottom: 15px;">
          Los servicios estÃ¡n marcados en el mapa con Ã­conos ğŸŸ¡ amarillos. Haz clic en ellos para ver mÃ¡s detalles.
        </p>

        <!-- Lista expandible de servicios -->
        <ion-list>
          <ion-item *ngFor="let servicio of serviciosDisponibles" lines="full">
            <ion-label class="ion-text-wrap">
              <h2><strong>ğŸ§© {{ servicio.nombre_servicio }}</strong></h2>
              <h3>{{ servicio.nombre_empresa }}</h3>
              <p>{{ servicio.descripcion_servicio }}</p>
              
              <div style="margin-top: 8px;">
                <p style="margin: 2px 0; font-size: 12px;">
                  ğŸ“ <strong>Lugar:</strong> {{ servicio.nombre_lugar || 'N/A' }}
                </p>
                <p style="margin: 2px 0; font-size: 12px;">
                  ğŸ“Œ <strong>DirecciÃ³n:</strong> {{ servicio.direccion_lugar || 'N/A' }}
                </p>
                <p *ngIf="servicio.horario_disponible" style="margin: 2px 0; font-size: 12px;">
                  ğŸ• <strong>Horario:</strong> {{ servicio.horario_disponible }}
                </p>
                <p style="margin: 2px 0; font-size: 12px;">
                  ğŸ’° <strong>Costo:</strong> {{ servicio.costo_servicio ? (servicio.costo_servicio | currency:'CLP':'symbol-narrow':'1.0-0') : 'Consultar' }}
                </p>
                <p *ngIf="servicio.nombre_discapacidad" style="margin: 2px 0; font-size: 12px;">
                  â™¿ <strong>Discapacidad:</strong> {{ servicio.nombre_discapacidad }}
                </p>
                <p *ngIf="servicio.empresa_telefono" style="margin: 2px 0; font-size: 12px;">
                  ğŸ“ <strong>Contacto:</strong> {{ servicio.empresa_telefono }}
                </p>
                <p *ngIf="servicio.resenas && servicio.resenas.length > 0" style="margin: 2px 0; font-size: 12px;">
                  â­ <strong>ValoraciÃ³n:</strong> {{ calcularPromedioValoracion(servicio.resenas) }}/5 
                  ({{ servicio.resenas.length }} reseÃ±a{{ servicio.resenas.length > 1 ? 's' : '' }})
                </p>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <!-- Mensaje si no hay servicios -->
      <div *ngIf="serviciosDisponibles.length === 0">
        <p style="text-align: center; color: #666;">
          ğŸ§© No hay servicios disponibles en este momento.<br>
          Pronto habrÃ¡ mÃ¡s servicios registrados.
        </p>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- ğŸŒŸ InformaciÃ³n de rutas guardadas (solo si estÃ¡ logueado) -->
  <ion-card *ngIf="isUserLoggedIn">
    <ion-card-header>
      <ion-card-title>ğŸŒŸ Tus Rutas Guardadas</ion-card-title>
      <ion-card-subtitle>
        {{ rutasGuardadas.length === 0 ? 'AÃºn no has creado rutas' : rutasGuardadas.length + ' ruta(s) disponible(s)' }}
      </ion-card-subtitle>
    </ion-card-header>
    
    <ion-card-content>
      <div *ngIf="rutasGuardadas.length === 0">
        <p style="text-align: center; color: #666;">
          ğŸ“ No tienes rutas GPS guardadas aÃºn.<br>
          Â¡Crea tu primera ruta para ayudar a otros usuarios!
        </p>
      </div>

      <div *ngIf="rutasGuardadas.length > 0">
        <p>
          Tus rutas estÃ¡n disponibles para visualizar. Usa los Ã­conos arriba:
          <br>ğŸ“ = Ver tu ubicaciÃ³n
          <br>ğŸ—ºï¸ = Ver/gestionar tus rutas
          <br>ğŸŒ = Ver rutas de otros usuarios
        </p>
        
        <ion-list>
          <ion-item *ngFor="let ruta of rutasGuardadas.slice(0, 3)">
            <ion-label>
              <h3>{{ ruta.nombre_ruta }}</h3>
              <p>{{ ruta.descripcion_ruta || 'Sin descripciÃ³n' }}</p>
              <p><small>ğŸ“ {{ ruta.longitud_ruta }} km | ğŸ“ {{ ruta.coordenadas?.length || 0 }} puntos GPS</small></p>
            </ion-label>
            <ion-button slot="end" fill="clear" (click)="cargarRutaEnMapa(ruta.id_ruta)">
              <ion-icon name="eye" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>

        <ion-button 
          *ngIf="rutasGuardadas.length > 3"
          expand="block" 
          fill="outline" 
          (click)="verMisRutas()">
          <ion-icon slot="start" name="list"></ion-icon>
          Ver todas ({{ rutasGuardadas.length }})
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- ğŸŒ InformaciÃ³n de rutas pÃºblicas -->
  <ion-card *ngIf="rutasPublicas.length > 0">
    <ion-card-header>
      <ion-card-title>ğŸŒ Rutas de Otros Usuarios</ion-card-title>
      <ion-card-subtitle>
        {{ rutasPublicas.length }} ruta(s) disponible(s) para explorar
      </ion-card-subtitle>
    </ion-card-header>
    
    <ion-card-content>
      <p style="text-align: center; margin-bottom: 15px;">
        Descubre rutas accesibles creadas por otros usuarios de la comunidad.
        <br>Â¡Explora nuevos caminos seguros!
      </p>

      <ion-button 
        expand="block" 
        color="secondary"
        (click)="verRutasPublicas()">
        <ion-icon slot="start" name="globe"></ion-icon>
        Explorar Rutas PÃºblicas ({{ rutasPublicas.length }})
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- ğŸ“Š EstadÃ­sticas (solo si estÃ¡ logueado y tiene rutas) -->
  <ion-card *ngIf="isUserLoggedIn && rutasGuardadas.length > 0">
    <ion-card-header>
      <ion-card-title>ğŸ“Š Tus EstadÃ­sticas</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="4">
            <div style="text-align: center;">
              <h2 style="margin: 0; color: #3880ff;">{{ rutasGuardadas.length }}</h2>
              <p style="margin: 5px 0; font-size: 12px;">Rutas creadas</p>
            </div>
          </ion-col>
          <ion-col size="4">
            <div style="text-align: center;">
              <h2 style="margin: 0; color: #10dc60;">{{ calcularDistanciaTotal() }}</h2>
              <p style="margin: 5px 0; font-size: 12px;">km totales</p>
            </div>
          </ion-col>
          <ion-col size="4">
            <div style="text-align: center;">
              <h2 style="margin: 0; color: #ffce00;">{{ rutasPublicas.length }}</h2>
              <p style="margin: 5px 0; font-size: 12px;">Rutas para explorar</p>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

</ion-content>